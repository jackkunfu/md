# 缓存

```
在http中，控制缓存开关的字段有两个：Pragma 和 Cache-Control。
Pragma有两个字段Pragma和Expires。Pragma的值为no-cache时，表示禁用缓存，Expires的值是一个GMT时间，表示该缓存的有效时间。
Pragma是旧产物，已经逐步抛弃，有些网站为了向下兼容还保留了这两个字段。
Pragma -> Cache-Control -> Expires
```

```
强缓存阶段
  先在本地查找该资源，如果发现该资源，并且其他限制也没有问题(比如:缓存有效时间)，就命中强缓存，返回 200，直接使用强缓存，并且不会发送请求到服务器
  利用 Expires 或者 Cache-Control 为文件设置一个过期时间，在多长时间内可以将这些内容视为最新的。
    若时间未过期，则命中强缓存，使用缓存文件不发送请求。
    命中强缓存时，有两种状态，200 (from memory cache) cache & 200 (from disk cache)
      两者区别当退出进程时，内存中的数据会被清空，而磁盘的数据不会。
      memory cache: 将资源存到内存中，从内存中获取
      disk cache：将资源缓存到磁盘中，从磁盘中获取。(可能会是：大文件，只会渲染一次的样式表，或者内存使用率高的时候)
```

```
弱缓存阶段
  在本地缓存中找到该资源，发送一个 http 请求到服务器，服务器判断这个资源没有被改动过，则返回 304，让浏览器使用该资源。
  Last-Modified & if-modified-since / ETag & If-None-Match
```

```
缓存失败阶段(重新请求)
  当服务器发现该资源被修改过，或者在本地没有找到该缓存资源，服务器则返回该资源的数据。
```

```
请求如何禁用缓存
  请求 url 增加版本号或者时间戳，不同的地址就会重新请求
```

```
Etag 优点：
  一些文件也许内容并不改变(仅仅改变的修改时间)，这个时候我们不希望文件重新加载。（Etag 值会触发缓存，Last-Modified 不会触发）
  If-Modified-Since 能检查到的粒度是秒级的，当修改非常频繁时，Last-Modified 会触发缓存，而 Etag 的值不会触发，重新加载。
  某些服务器不能精确的得到文件的最后修改时间。

Etag 流程：
  服务器通过某个算法对资源进行计算，取得一串值(类似于文件的md5值)
  之后将该值通过etag返回给客户端
  客户端下次请求时通过If-None-Match或If-Match带上该值，服务器对该值进行对比校验：如果一致则不要返回资源。

  If-None-Match 和 If-Match 的区别是：
    If-None-Match：告诉服务器如果一致，返回状态码304，不一致则返回资源
    If-Match：告诉服务器如果不一致，返回状态码412 --- precondition failed
```

```
Cache-Control: 请求头、响应头中都可以添加此数据属性
  当 Expires 和 Cache-Control 同时存在时，Cache-Control 优先级高于 Expires
  服务器时间或者本地时间不对的时候，Expires 可能就会比较混乱，不起作用
  public： 服务器端和浏览器端都能缓存
  private: 只能浏览器端缓存
  no-cache: 强制浏览器在使用 cache 拷贝之前先提交一个 http 请求到源服务器进行确认。http 请求没有减少，会减少一个响应体(文件内容),这种个选项类似弱缓存。
  only-if-cached: 表明客户端只接受已缓存的响应，并且不要向原始服务器检查是否有更新的拷贝。
  max-age=60：设置缓存存储的最大周期，超过这个时间缓存被认为过期(单位秒)。 这里是 60 秒
  no-store: 不缓存，使用协商缓存
  must-revalidate: 缓存必须在使用之前验证旧资源的状态，并且不可使用过期资源。
  在请求中使用Cache-Control 时，它可选的值有：

```

# 加载资源机制

```
先去内存看，如果有，直接加载；
如果内存没有，则取硬盘获取，如果有直接加载；
如果硬盘也没有，那么就进行网络请求；
加载到的资源缓存到硬盘和内存。
```

```
浏览器会把哪些文件丢进内存中？哪些丢进硬盘中？
对于大文件来说，大概率是不存储在内存中的，反之优先
当前系统内存使用率高的话，文件优先存储进硬盘
```

# nginx 相关配置

```
# 1、启用缓存
location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|js|css)$ {
  #设置缓存上面定义的后缀文件缓存到浏览器的生存时间
  expires 3d;
}
# 2、禁用缓存
location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|js|css)$ {
  #禁止缓存，每次都从服务器请求
  add_header Cache-Control no-store;
}
```

# 离线缓存
